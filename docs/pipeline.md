# Описание платформы

## Методы

### Вычислительный конвейер

За основу биоинформационного пайплайна взяты рекомендации института Броуда (GATK Best Practices на базе GATK4) для поиска герминальных и соматических мутаций с применением стандартов гармонизации алгоритмов из проекта Centers for Common Disease Genomics &ndash; использование валидированных научным сообществом подходов обеспечивает высокие показатели чувствительности и специфичности проводимого анализа. Особенностью пайплайна является одновременное использование трех алгоритмов поиска нуклеотидных вариантов &ndash; GATK4 HaplotypeCaller/Mutect2, Strelka2 и DRAGEN, что позволяет значительно снизить количество ложноположительных результатов.

Схема универсального конвейера для версии генома hg38 представлена на рисунке:

![Pipeline scheme](/assets/scheme.svg)

Пайплайн построен по модульному принципу с использованием общих вычислительных блоков для облегчения внесения изменений в алгоритмы и контроля версий.
Вычислительный конвейер автоматически подстраивается под размер входных файлов и распределяет нагрузку по необходимому числу контейнеров, что дает возможность быстро и эффективно обрабатывать данные любого размера &ndash; от таргетных панелей до экзомов и геномов. Каждый модуль выполняется в изолированном окружении с динамическим выделением ресурсов, требуемых для обработки загруженного набора файлов, а облачная среда снимает ограничения на количество одновременно анализируемых образцов.

### Архитектура

Платформа XplainBio спроектирована для максимальной масштабируемости алгоритмов обработки геномных данных. Современные решения из мира Big Data (технологии Apache Spark и Kubernetes) распареллеливают вычисления пайплайна BWA/GATK4 и ускоряют ресурсоемкие этапы картирования и поиска вариантов, а облачный подход обеспечивает эластичность при росте нагрузки, предоставляя необходимое количество ресурсов (до 4096 вычислительных ядер CPU).

 
### Точность

Внедрение в практику экзомного и геномного секвенирования остро поставило вопрос аналитических характеристик используемых методов. Для правильной интерпретации результата теста важно иметь информацию о его точности, чувствительности и специфичности. К сожалению, из-за сложности NGS-секвенирования этот вопрос далек от окончательного решения, но научное сообщество предприняло ряд усилий для характеризации методик. В рамках проекта [Genome in a Bottle](https://www.nist.gov/programs-projects/genome-bottle) на нескольких платформах были отсеквенированы эталонные клеточные линии от добровольцев, данные секвенирования объединили для получения кросс-валидированных высокодостоверных наборов вариантов, с которыми можно сравнивать результаты работы пайплайнов, подробнее о методике проведения сравнительных измерений референсного образца GiaB/NIST NA12878/HG001 с помощью пайплайна XplainBio можно прочитать по [ссылке](recall.md). Целевым параметром оптимизации пайплайна был показатель чувствительности (Recall) при сохранении высокого уровня PPV (Precision).

### Производительность

Ниже представлена таблица сравнения вычислительных ресурсов различных секвенаторов и облачного решения. Для NovaSeq 6000 указаны характеристики управляющего компьютера, так как обработка данных полностью перенесена в Illumina BaseSpace. Для облака указаны пиковые значения. Данные взяты из официальных спецификаций.

|	<small>Прибор</small>	|	<small>Процессор</small>	|	<small>Частота</small>	|	<small>Дата выпуска CPU</small>	|	<small>CPU</small>	|	<small>RAM</small>	|	<small>Время анализа</small>	|
|	:--------------------	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|
|	<small>MiniSeq</small>	|	<small>Intel Core i7-4700EQ</small>	|	<small>2.40 GHz</small>	|	<small>2013</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>MiSeq</small>	|	<small>Intel Core i7-2710QE</small>	|	<small>2.10 GHz</small>	|	<small>2011</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 1000</small>	|	<small>Dual Intel Xeon X5560</small>	|	<small>2.30 GHz</small>	|	<small>2009</small>	|	<small>8</small>	|	<small>48 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 1500/2000</small>	|	<small>Dual Intel Xeon E5-2630</small>	|	<small>2.30 GHz</small>	|	<small>2012</small>	|	<small>12</small>	|	<small>64 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 2500</small>	|	<small>Dual Intel Xeon E5-2620</small>	|	<small>2.00 GHz</small>	|	<small>2012</small>	|	<small>12</small>	|	<small>64 Гб</small>	|	<small>-</small>	|
|	<small>NextSeq 500/550</small>	|	<small>Dual Intel Xeon ES-2448L</small>	|	<small>1.80 GHz</small>	|	<small>2012</small>	|	<small>16</small>	|	<small>96 Гб</small>	|	<small>более 45 часов</small>	|
|	<small>HiSeq 3000/4000/X</small>	|	<small>Dual Intel Xeon 5-2697 v2</small>	|	<small>2.70 GHz</small>	|	<small>2013</small>	|	<small>24</small>	|	<small>128 Гб</small>	|	<small>более 38 часов</small>	|
|	<small>NovaSeq 6000</small>	|	<small>Intel Core i7-4700EQ</small>	|	<small>2.40 GHz</small>	|	<small>2013</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>Облако XplainBio</small>	|	<small>Intel Xeon Ice Lake</small>	|	<small>2.6/3.8 GHz</small>	|	<small>2021</small>	|	<small>до 4096</small>	|	<small>8 192 Гб</small>	|	<small>менее 2 часов</small>	|

Сравнение времени обработки референсного образца GiaB/NIST NA12878/HG001 (Illumina HiSeq, Nextera Expanded Exome, набор файлов FASTQ общим размером 16 Гб доступен по [ссылке](http://ftp-trace.ncbi.nlm.nih.gov/giab/ftp/data/NA12878/Garvan_NA12878_HG001_HiSeq_Exome/)) с помощью локального сервера и облачной платформы XplainBio. Большое время обработки на локальном сервере обусловлено тем, что инструмент HaplotypeCaller из набора GATK4 всегда работает в однопоточном режиме (несколько потоков использует только алгоритм PairHMM) и не может максимально эффективно загрузить все доступные процессорные мощности без применения кластерных/облачных технологий. Подробнее о методах параллелизации вычислений можно прочитать по [ссылке](perfomance.md).

|	<small>Тип анализа</small>	|	<small>Пайплайн BWA/GATK4</small>	|	<small>Сервер<br/> 16&nbsp;CPU,&nbsp;64&nbsp;Гб</small>	|	<small>Облако XplainBio</small>	|
|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|
|	<small>Без&nbsp;аннотирования</small>	|	<small>Adapter trimming, BWA-MEM, Dedup, BQSR, HaplotypeCaller+Strelka2+DRAGEN, CNN filtering, Hard filtering, метрики качества, оценка покрытия по экзонам</small>	|	<small>52ч 17м</small>	|	<small>1ч 01м</small>	|
|	<small>С&nbsp;аннотированием</small>	|	<small>+ аннотирование по 26 базам данных</small>	|	<small>53ч 04м</small>	|	<small>1ч 29м</small>	|

## Алгоритмы

### Удаление адаптеров

Входные пары файлов FASTQ обрабатываются с помощью утилиты fastp в режиме автоопределения адаптеров, с 3`-конца удаляются все N и буквы с качеством менее 15 методом "скользящего окна" (размер окна 6 нуклеотидов), для NextSeq/NovaSeq также удаляются поли-G. Полностью удаляются все риды, содержащие более 40% букв с качеством менее 15, и риды длиной менее 36.
Для ускорения дальнейшей обработки файлы разделяются на фрагменты, содержащие по 5 миллионов прочтений, а для режима поиска соматических мутаций в ампликонах дополнительно обрабатываются утилитой Trimmomatic, так как данный тип анализа чрезвычайно чувствителен даже к следовым количествам адаптеров.

### Картирование прочтений

Фрагменты размером 5 миллионов прочтений конвертируются в формат uBAM с автоматическим назначением групп чтения для каждой входной пары файлов FASTQ, затем картируются на геном с помощью алгоритма BWA-MEM с получением набора BAM-файлов. Предварительное разбиение на фрагменты позволяет эффективно контролировать время выполнения этапа картирования для входных файлов любого размера &ndash; от экзома до генома.

### Маркировка дубликатов и сортировка

Полученный комплект BAM-файлов в зависимости от размера и необходимости маркировки дубликатов подвергается обработке с помощью утилит bamsormadup, bamsort или MarkDuplicatesSpark с одновременным объединением в один файл.

### Рекалибровка значений качества

Рекалибровка проводится с помощью инструмента BaseRecalibrator из GATK4, для ускорения набор интервалов разделяется на фрагменты, содержащие примерно 300-500 миллионов прочитанных оснований в одной группе чтения (если количество недостаточно &ndash; файл обрабатывается без разделения). Полученные оценки объединяются и применяются к исходному BAM-файлу.

### Поиск нуклеотидных вариантов

Поиск вариантов производится параллельно с помощью алгоритмов DRAGEN, Strelka2 и HaplotypeCaller/Mutect2 из GATK4, для ускорения инструментов GATK4 набор интервалов разделяется на фрагменты примерно равного размера (для генома интервалы делятся по -NNNNNN-), которые обрабатываются независимо друг от друга. Получившиеся VCF-файлы объединяются с удалением дублирующихся строк.

### Фильтрация герминальных вариантов

Постобработка вариантов проводится двумя способами &ndash; с помощью предобученной нейронной сети (CNNScoreVariants из GATK4, модель 2D) и с помощью индивидуальных фильтров по качеству, критерии фильтрации следующие:

  - LowDP &ndash; DP < 10.0
  - GATKCutoffEndOfReads &ndash; QD < 10.0 и AD[1]/(AD[1]+AD[0]) < 0.25 и ReadPosRankSum&nbsp;<&nbsp;0.0
  - GATKCutoffSNP &ndash; QD < 4.0 или FS > 60.0 или MQ < 30.0 или MQRankSum < -13.5 или ReadPosRankSum&nbsp;<&nbsp;-8.0
  - GATKCutoffIndel &ndash; QD < 4.0 или FS > 200.0 или SOR > 10.0 или ReadPosRankSum&nbsp;<&nbsp;-20.0
  - CNN-SNP-tranche &ndash; 99.9
  - CNN-INDEL-tranche &ndash; 99.5

Ни один из вариантов не удаляется &ndash; итоговые таблицы и VCF-файлы содержат все варианты, полученные в результате поиска, фильтрация предназначена для облегчения последующей интерпретации и оценки достоверности обнаруженных мутаций.

### Фильтрация соматических вариантов

Постобработка вариантов производится инструментами CalculateContamination, LearnReadOrientationModel и FilterMutectCalls из пакета GATK4. С помощью набора из 20 фильтров оценивается вероятность ошибки для каждого из вариантов по трем категориям: технические артефакты, несоматические замены и ошибки секвенирования. Используются следующие обозначения:

  - clustered_events &ndash; превышено пороговое количество отфильтрованных вариантов в регионе сборки&nbsp;(>2)
  - duplicate_evidence &ndash; подозрение на наличие дубликатов в прочтениях с альтернативным аллелем
  - multiallelic &ndash; превышено пороговое количество альтернативных аллелей&nbsp;(>1)
  - base_quality &ndash; среднее значение качества оснований альтернативных прочтений ниже порога&nbsp;(<20)
  - mapping_quality &ndash; среднее значение качества картирования альтернативных прочтений ниже порога&nbsp;(<30)
  - fragment_length &ndash; средняя длина альтернативных прочтений сильно отличается от средней длины референсных прочтений
  - read_position &ndash; средняя позиция мутации находится слишком близко к одному из концов альтернативных прочтений
  - panel_of_normals &ndash; вариант присутствует в панели нормальных образцов
  - germline &ndash; вариант имеет признаки герминального
  - slippage &ndash; вариант находится в регионе гомополимеров или тандемных повторов
  - strand_bias &ndash; альтернативный аллель содержится в прочтениях преимущественно одного направления
  - haplotype &ndash; вариант находится вблизи уже отфильтрованного варианта в том же гаплотипе
  - contamination &ndash; наличие варианта обусловлено контаминацией
  - weak_evidence &ndash; вариант не достиг порога вероятности
  - orientation &ndash; замена обусловлена химическими изменениями оснований, произошедшими только в одной цепи
  - normal_artifact &ndash; технический артефакт, присутствующий в нормальном парном образце

### Нормализация VCF-файлов

Для корректной работы с базами аннотаций все варианты выравниваются по левому краю (left normalization), мультиаллельные варианты разделяются, списки вариантов проверяются на уникальность значений.

### Аннотирование вариантов

Аннотация каждого варианта выполняется по следующим источникам данных:

  - RefSeq (гены и транскрипты, положение по кДНК и аминокислотной последовательности по правилам HGVS)
  - MANE (выбор транскрипта по умолчанию)
  - база эффектов сплайсинга
  - dbSNP
  - gnomAD
  - OMIM
  - ClinVar
  - HGMD (публичная)
  - поля VCF (глубина прочтений, аллельный баланс, качество, гомополимерное окружение, повторы&nbsp;и&nbsp;т.д.)
  - алгоритмы предсказания патогенности SIFT, PolyPhen HDIV/HVAR, Mutation Taster, FATHMM, CADD, DANN, M‑CAP, REVEL, BayesDel, ClinPred, LIST-S2
  - локальная база патогенных мутаций

##  Точность

Точное обнаружение мутаций при секвенировании нового поколения (NGS) является основным требованием для применения этого метода в практической медицине, однако, серьезную проблему представляет собой низкая согласованность результатов между различными вариантами пайплайнов разных платформ секвенирования. За короткое время (2012-2020 гг.) биоинформационные подходы совершили качественный скачок в своем развитии, улучшив показатели чувствительности и специфичности с посредственных 70-80% до значений выше 99%, и если раньше высокие показатели обеспечивались комбинированием нескольких подходов, то недавнее сравнение 70 пайплайнов (все комбинации 7 инструментов картирования и 10 инструментов поиска вариантов - [Hwang, K., Lee, I., Li, H. et al. 2019. Comparative analysis of whole-genome sequencing pipelines to minimize false negative findings. Sci Rep. 9, 3219](https://www.nature.com/articles/s41598-019-39108-2)) выявило лидера – BWA-MEM/GATK3-HC продемонстрировал максимальные значения Recall (чувствительность) и Precision (прогностическая ценность положительного результата, PPV), которые превысили даже показатели объединенных наборов данных нескольких инструментов. При этом был зафиксирован значительный разброс между различными комбинациями программ, что говорит о необходимости валидации применяемых в лабораториях биоинформационных решений. Для оценки аналитических характеристик алгоритмов в рамках проекта [Genome in a Bottle](https://www.nist.gov/programs-projects/genome-bottle) (GiaB) на нескольких платформах были отсеквенированы эталонные клеточные линии от добровольцев, данные секвенирования объединили для получения кросс-валидированных высокодостоверных наборов вариантов, с которыми можно сравнивать результаты работы пайплайнов.

Критическими для целей клинического применения значениями являются чувствительность и PPV, их важность становится понятна из этой таблицы:

![Spec table](/assets/spec.svg)

Разные виды ошибок имеют разную значимость при выполнении NGS &ndash; ложноположительные результаты, как правило, можно оценить в ручном режиме по анализу сырых данных или перепроверить секвенированием по Сэнгеру, ложноотрицательные результаты обнаруживаются только при переделке анализа. По этой причине целевым параметром оптимизации пайплайнов является показатель чувствительности (Recall, низкое число ложноотрицательных) при сохранении высокого уровня PPV (Precision, низкое число ложноположительных). Высокое значение Recall позволяет быть уверенным в том, что существующие в сырых данных мутации не будут пропущены на этапе биоинформационного анализа, а высокий показатель PPV значительно облегчает интерпретацию результатов, заранее отмечая (но не удаляя из списка вариантов) нуклеотидные замены, которые с большой долей вероятности являются артефактами секвенирования и замедляют проведение исследования. Аналитическая специфичность в NGS не имеет определяющего значения, так как в силу особенностей методики количество истинноотрицательных приблизительно равно размеру изучаемой панели и Specificity всегда близка к 100%.

На точность и воспроизводимость идентификации мутаций влияют множество параметров &ndash; глубина покрытия, качество картирования, GC-окружение, наличие повторов ДНК, версии и настройки программ, поэтому результаты сравнения VCF-файлов могут значительно различаться в зависимости от выбора подмножества вариантов, участвующих в расчете характеристик точности. Консорциум GiaB совместно с платформой PrecisionFDA разработали рекомендации по проведению тестирования, но важно отметить, что анализ проводится только в "простых" регионах генома (high-confidence regions), поэтому полученные оценки всегда завышены по сравнению с полными панелями, но тем не менее, при стандартизации подходов к тестированию это дает возможность прямого сопоставления различных версий пайплайнов. Достоверные наборы вариантов для проблемных регионов (центромеры, повторы и т.д.) находятся в процессе разработки и пока редко используются в целях тестирования, так как согласованность результатов между методами секвенирования коротких фрагментов и одномолекулярными длинными прочтениями в этих локусах не превышает 60-70%. Также одним из недостатков рекомендованного подхода является необходимость ручной проверки ложноположительных и ложноотрицательных вариантов &ndash; несовпадения могут быть вызваны не ошибками алгоритмов пайплайна, а несовершенством инструментов сравнения, неспособных распознать некоторые одинаковые генетические варианты, по-разному представленные в VCF-файлах.

Результаты работы XplainBio сравнивались c высокодостоверными вариантами для генома стандартного образца NA12878/HG001 на платформе PrecisionFDA (инициатива Управления по санитарному надзору за качеством пищевых продуктов и медикаментов, обеспечивающая облачное решение для разработки, тестирования, валидации и сравнения биоинформационных пайплайнов на основе референсных образцов). Для генома использовались рекомендуемые VCF- и BED-файлы из набора данных NIST v3.3.2, Режимы фильтрации GATK4 HaplotypeCaller &ndash; фильтры по качеству (QD, FS, MQ, MQRankSum, ReadPosRankSum, SOR), сверточная нейросеть (CNN), подсчет для всех алгоритмов велся только по вариантам с фильтром PASS. Результаты представлены в таблице:

|Вид анализа                  |Precision|Recall    |F-measure|FN      |
|:----------------------------|:-------:|:--------:|:-------:|:------:|
|GATK4 HC+CNN SNP             |99,77%   |99,91%    |99,84%   |2750    |
|GATK4 HC+CNN INDEL           |99,47%   |99,02%    |99,25%   |4907    |
|Strelka2 SNP                 |99,92%   |99,88%    |99,90%   |3600    |
|Strelka2 INDEL               |99,59%   |99,22%    |99,41%   |3908    |
|DRAGEN SNP                   |99,86%   |99,93%    |99,90%   |2051    |
|DRAGEN INDEL                 |99,61%   |99,62%    |99,61%   |1918    |
|Объединенные результаты SNP  |99,70%   |**99,98%**|99,84%   |**560** |
|Объединенные результаты INDEL|99.19%   |**99,63%**|99,40%   |**1874**|

Из приведенных данных видно, что использование дополнительных методов поиска мутаций (Strelka2+DRAGEN) значительно снижает количество ложноотрицательных результатов и в то же время не сильно влияет на показатель Precision, особенно заметна разница в недостаточно покрытых областях, где часто наблюдаются пропуски альтернативных аллелей или неверное определение генотипов. Следует отметить, что значительная часть ложноотрицательных вариантов были обнаружены одним из алгоритмов, они присутствуют в VCF-файлах и итоговой таблице, но помечены фильтром по критерию качества картирования прочтений.

##  Производительность

...

##  _In&nbsp;silico_


...

## База мутаций xMD

...

## ACMG

...

## HPO

...