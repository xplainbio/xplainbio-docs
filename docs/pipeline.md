# Методы &ndash; вычислительный конвейер

## Описание

За основу биоинформационного пайплайна взяты рекомендации института Броуда (GATK Best Practices на базе GATK4) для поиска герминальных и соматических мутаций с применением стандартов гармонизации алгоритмов из проекта Centers for Common Disease Genomics – использование валидированных научным сообществом подходов обеспечивает высокие показатели чувствительности и специфичности проводимого анализа. Особенностью пайплайна является одновременное использование трех алгоритмов поиска нуклеотидных вариантов &ndash; GATK4 HaplotypeCaller/Mutect2, Strelka2 и DRAGEN, что позволяет значительно снизить количество ложноположительных результатов.

Схема универсального конвейера для версии генома hg38 представлена на рисунке:

![Pipeline scheme](/assets/scheme.svg)

Пайплайн построен по модульному принципу с использованием общих вычислительных блоков для облегчения внесения изменений в алгоритмы и контроля версий.
Вычислительный конвейер автоматически подстраивается под размер входных файлов и распределяет нагрузку по необходимому числу контейнеров, что дает возможность быстро и эффективно обрабатывать данные любого размера - от таргетных панелей до экзомов и геномов. Каждый модуль выполняется в изолированном окружении с динамическим выделением ресурсов, требуемых для обработки загруженного набора файлов, а облачная среда снимает ограничения на количество одновременно анализируемых образцов.

## Архитектура

Платформа XplainBio спроектирована для максимальной масштабируемости алгоритмов обработки геномных данных. Современные решения из мира Big Data (технологии Apache Spark и Kubernetes) распареллеливают вычисления пайплайна BWA/GATK4 и ускоряют ресурсоемкие этапы картирования и поиска вариантов, а облачный подход обеспечивает эластичность при росте нагрузки, предоставляя необходимое количество ресурсов (до 4096 вычислительных ядер CPU).

 
## Точность

Внедрение в практику экзомного и геномного секвенирования остро поставило вопрос аналитических характеристик используемых методов. Для правильной интерпретации результата теста важно иметь информацию о его точности, чувствительности и специфичности. К сожалению, из-за сложности NGS-секвенирования этот вопрос далек от окончательного решения, но научное сообщество предприняло ряд усилий для характеризации методик. В рамках проекта [Genome in a Bottle](https://www.nist.gov/programs-projects/genome-bottle) на нескольких платформах были отсеквенированы эталонные клеточные линии от добровольцев, данные секвенирования объединили для получения кросс-валидированных высокодостоверных наборов вариантов, с которыми можно сравнивать результаты работы пайплайнов, подробнее о методике проведения сравнительных измерений референсного образца GiaB/NIST NA12878/HG001 с помощью пайплайна XplainBio можно прочитать по [ссылке](recall.md). Целевым параметром оптимизации пайплайна был показатель чувствительности (Recall) при сохранении высокого уровня PPV (Precision).

## Производительность

Ниже представлена таблица сравнения вычислительных ресурсов различных секвенаторов и облачного решения. Для NovaSeq 6000 указаны характеристики управляющего компьютера, так как обработка данных полностью перенесена в Illumina BaseSpace. Для облака указаны пиковые значения. Данные взяты из официальных спецификаций.

|	<small>Прибор</small>	|	<small>Процессор</small>	|	<small>Частота</small>	|	<small>Дата выпуска CPU</small>	|	<small>CPU</small>	|	<small>RAM</small>	|	<small>Время анализа</small>	|
|	:--------------------	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|
|	<small>MiniSeq</small>	|	<small>Intel Core i7-4700EQ</small>	|	<small>2.40 GHz</small>	|	<small>2013</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>MiSeq</small>	|	<small>Intel Core i7-2710QE</small>	|	<small>2.10 GHz</small>	|	<small>2011</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 1000</small>	|	<small>Dual Intel Xeon X5560</small>	|	<small>2.30 GHz</small>	|	<small>2009</small>	|	<small>8</small>	|	<small>48 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 1500/2000</small>	|	<small>Dual Intel Xeon E5-2630</small>	|	<small>2.30 GHz</small>	|	<small>2012</small>	|	<small>12</small>	|	<small>64 Гб</small>	|	<small>-</small>	|
|	<small>HiSeq 2500</small>	|	<small>Dual Intel Xeon E5-2620</small>	|	<small>2.00 GHz</small>	|	<small>2012</small>	|	<small>12</small>	|	<small>64 Гб</small>	|	<small>-</small>	|
|	<small>NextSeq 500/550</small>	|	<small>Dual Intel Xeon ES-2448L</small>	|	<small>1.80 GHz</small>	|	<small>2012</small>	|	<small>16</small>	|	<small>96 Гб</small>	|	<small>более 45 часов</small>	|
|	<small>HiSeq 3000/4000/X</small>	|	<small>Dual Intel Xeon 5-2697 v2</small>	|	<small>2.70 GHz</small>	|	<small>2013</small>	|	<small>24</small>	|	<small>128 Гб</small>	|	<small>более 38 часов</small>	|
|	<small>NovaSeq 6000</small>	|	<small>Intel Core i7-4700EQ</small>	|	<small>2.40 GHz</small>	|	<small>2013</small>	|	<small>4</small>	|	<small>16 Гб</small>	|	<small>-</small>	|
|	<small>Облако XplainBio</small>	|	<small>Intel Xeon Ice Lake</small>	|	<small>2.6/3.8 GHz</small>	|	<small>2021</small>	|	<small>до 4096</small>	|	<small>8 192 Гб</small>	|	<small>менее 2 часов</small>	|

Сравнение времени обработки референсного образца GiaB/NIST NA12878/HG001 (Illumina HiSeq, Nextera Expanded Exome, набор файлов FASTQ общим размером 16 Гб доступен по [ссылке](http://ftp-trace.ncbi.nlm.nih.gov/giab/ftp/data/NA12878/Garvan_NA12878_HG001_HiSeq_Exome/)) с помощью локального сервера и облачной платформы XplainBio. Большое время обработки на локальном сервере обусловлено тем, что инструмент HaplotypeCaller из набора GATK4 всегда работает в однопоточном режиме (несколько потоков использует только алгоритм PairHMM) и не может максимально эффективно загрузить все доступные процессорные мощности без применения кластерных/облачных технологий. Подробнее о методах параллелизации вычислений можно прочитать по [ссылке](perfomance.md).

|	<small>Тип анализа</small>	|	<small>Пайплайн BWA/GATK4</small>	|	<small>Сервер<br/> 16&nbsp;CPU,&nbsp;64&nbsp;Гб</small>	|	<small>Облако XplainBio</small>	|
|	:--------------------:	|	:--------------------:	|	:--------------------:	|	:--------------------:	|
|	<small>Без аннотирования</small>	|	<small>dapter trimming, BWA-MEM, Dedup, BQSR, HaplotypeCaller+Strelka2+DRAGEN, CNN filtering, Hard filtering, метрики качества, оценка покрытия по экзонам</small>	|	<small>52ч 17м</small>	|	<small>3ч 11м</small>	|
|	<small>С аннотированием</small>	|	<small>+ аннотирование по 26 базам данных</small>	|	<small>53ч 04м</small>	|	<small>3ч 40м</small>	|

